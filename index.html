<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Chat App</h1>

    <div class="room_buttons">

    </div>

    <ul id="messages">

    </ul>

    <form action="" id="form">
        <label for="preview">Preview:</label>
        <!-- <p id="preview"></p> -->
        <input type="text" id="name" required>
        <input type="text" id="message" required>
        <button id="send" type="submit">Send</button>
    </form>

    <button id="emojis">Emojis</button>
    
    <div class="keyboard" hidden>
        <button id="lion"><span>&#129409;</span></button>
        <button id="grinning face"><span>&#128512;</span></button>
        <button id="tears of joy"><span>&#128514;</span></button>
        <button id="smiling face"><span>&#128522;</span></button>
        <button id="sunglasses"><span>&#128526;</span></button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        let messages = document.querySelector('#messages');
        let form = document.querySelector('#form');
        // let preview = document.querySelector('#preview');
        let msg = document.querySelector('#message');
        let name1 = document.querySelector('#name');

        let keyboard = document.querySelector(".keyboard");

        let room_buttons = document.querySelector(".room_buttons");

        let emojis_button = document.querySelector("#emojis");

        emojis_button.addEventListener("click", evt => {
            keyboard.hidden = !keyboard.hidden;
        });

        let arr = [].slice.call(keyboard.children);

        arr.forEach(btn => {
            btn.addEventListener("click", evt => {
            msg.value += btn.children[0].innerHTML;
        });
        })

        // let lion_emoji = document.querySelector('#lion');

        // lion_emoji.addEventListener("click", evt => {
        //     console.log(evt, msg.innerHTML, lion_emoji.children[0].innerHTML, lion_emoji.children[0].innerText);
        //     msg.value += lion_emoji.children[0].innerHTML;
        // });

        form.addEventListener('submit', (event)=>{
            event.preventDefault();
            if(msg.value && name1.value){
                socket.emit('chat message', {name: name1.value, message: msg.value});
                msg.value='';
                // preview.innerHTML = "";
            }
        })

        // msg.addEventListener("change", evt => {
        //     preview.innerHTML = msg.value;
        // });

        let rooms = {}

        rooms.global = []

        rooms.test = [];

        Object.keys(rooms).forEach(item => {
            let btn = document.createElement("button");
            btn.innerText = item;
            room_buttons.appendChild(btn);
        });

        socket.on('chat message', msg => {
            let chatMessage = document.createElement('li');

            chatMessage.addEventListener("dblclick", evt => {
                if (!rooms[msg.from])
                {
                    rooms[msg.from] = [];
                    let btn = document.createElement("button");
                    btn.innerText = msg.from;
                    room_buttons.appendChild(btn);
                }
            });

            let span = document.createElement("span");
            span.innerHTML = msg.content;
            chatMessage.appendChild(span);
            messages.appendChild(chatMessage);

            rooms.global.push(chatMessage);
        })
    </script>
    <link rel="stylesheet" href="layout.css">
</body>
</html>