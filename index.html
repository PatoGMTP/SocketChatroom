<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>Chat App</h1>

    <div class="room_buttons">

    </div>

    <ul id="messages">

    </ul>

    <form action="" id="form">
        <label for="preview">Preview:</label>
        <input type="text" id="name" required>
        <input type="text" id="message" required>
        <button id="send" type="submit">Send</button>
    </form>

    <button id="emojis">Emojis</button>
    
    <div class="keyboard" hidden>
        <button id="lion"><span>&#129409;</span></button>
        <button id="grinning face"><span>&#128512;</span></button>
        <button id="tears of joy"><span>&#128514;</span></button>
        <button id="smiling face"><span>&#128522;</span></button>
        <button id="sunglasses"><span>&#128526;</span></button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        let in_global = true;
        let current_room = "";
        let user = "";

        let messages = document.querySelector('#messages');
        let form = document.querySelector('#form');
        let msg = document.querySelector('#message');
        let name1 = document.querySelector('#name');

        // Prepare Emoji Keyboard

        let emojis_button = document.querySelector("#emojis");
        emojis_button.addEventListener("click", evt => {
            keyboard.hidden = !keyboard.hidden;
        });

        let keyboard = document.querySelector(".keyboard");
        let arr = [].slice.call(keyboard.children);
        arr.forEach(btn => {
            btn.addEventListener("click", evt => {
            msg.value += btn.children[0].innerHTML;
        });
        })

        // Allow user to send message via socket

        form.addEventListener('submit', (event)=>{
            event.preventDefault();
            if(msg.value && name1.value){

                user = name1.value;

                if (in_global)
                {
                    socket.emit('chat message', {name: name1.value, message: msg.value});
                    msg.value='';
                }
                else
                {
                    socket.to(current_room).emit('chat message', {name: name1.value, message: msg.value})
                    msg.value='';
                }
            }
        })

        // Prepare chat rooms

        let room_buttons = document.querySelector(".room_buttons");
        let rooms = {}
        rooms.global = []
        Object.keys(rooms).forEach(item => {
            let btn = document.createElement("button");
            btn.innerText = item;
            room_buttons.appendChild(btn);
        });

        // Populate list with messages

        socket.on('chat message', msg => {
            let chatMessage = document.createElement('li');

            chatMessage.addEventListener("dblclick", evt => {
                if (!rooms[msg.from])
                {
                    console.log(msg);
                    rooms[msg.from] = [];
                    let btn = document.createElement("button");
                    btn.innerText = msg.from;
                    room_buttons.appendChild(btn);
                    socket.emit("join room", {room: msg.dms, user: user});
                }
            });

            let span = document.createElement("span");
            span.innerHTML = msg.content;
            chatMessage.appendChild(span);
            messages.appendChild(chatMessage);

            rooms.global.push(chatMessage);
        })

        socket.on("new roommate", obj => {
            console.log(obj);
            if (!rooms[user])
            {
                rooms[user] = [];
                let btn = document.createElement("button");
                btn.innerText = user;
                room_buttons.appendChild(btn);
            }
        });
    </script>
</body>
</html>